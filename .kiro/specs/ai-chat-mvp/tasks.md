# 実装計画: AI Chat MVP

## 概要

本実装計画は、OpenAIとClaudeの複数のLLMモデルに対応したストリーミングチャット機能を持つWebアプリケーションのMVPを構築します。バックエンドはFastAPI + Python、フロントエンドはReact + TypeScriptで実装し、SQLiteでメッセージを永続化します。

## タスク

- [x] 1. プロジェクト構造とセットアップ
  - バックエンド（FastAPI）とフロントエンド（React）のディレクトリ構造を作成
  - uvを使用してPythonプロジェクトを初期化（Python 3.11+）
  - Viteを使用してReact + TypeScriptプロジェクトを初期化
  - 必要な依存関係をインストール（FastAPI、SQLAlchemy、openai、anthropic、uvicorn等）
  - 環境変数設定用の.env.exampleファイルを作成
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 2. データベース層の実装
  - [x] 2.1 SQLAlchemyモデルとリポジトリを実装
    - Messageモデルを定義（id, role, content, model, timestamp）
    - MessageRepositoryクラスを実装（save_message, get_all_messages）
    - データベース初期化処理を実装
    - _要件: 3.1, 3.2, 3.3_
  
  - [x] 2.2 メッセージ永続化のプロパティテストを作成
    - **プロパティ 3: メッセージの永続化**
    - **検証: 要件 3.1, 3.2**
  
  - [x] 2.3 保存データ完全性のプロパティテストを作成
    - **プロパティ 7: 保存データの完全性**
    - **検証: 要件 3.3**
  
  - [x] 2.4 データベースエラーハンドリングのユニットテストを作成
    - データベース書き込みエラー時のログ記録を検証
    - エラー時にもアプリケーションが継続することを検証
    - _要件: 3.4_

- [x] 3. LLMサービス層の実装
  - [x] 3.1 抽象LLMProviderインターフェースを定義
    - LLMProvider抽象基底クラスを実装
    - stream_chat抽象メソッドを定義
    - _要件: 6.1_
  
  - [x] 3.2 OpenAIProviderを実装
    - OpenAI Python SDKを使用してストリーミングチャットを実装
    - APIキーを環境変数から読み込み
    - _要件: 6.2, 5.1, 5.3_
  
  - [x] 3.3 ClaudeProviderを実装
    - Anthropic Python SDKを使用してストリーミングチャットを実装
    - OpenAI形式からClaude形式へのメッセージ変換を実装
    - APIキーを環境変数から読み込み
    - _要件: 6.3, 5.1, 5.3_
  
  - [x] 3.4 LLMServiceファサードを実装
    - プロバイダーマッピングを定義（モデル名→プロバイダー）
    - 統一されたstream_chatインターフェースを実装
    - _要件: 6.1, 6.4_
  
  - [x] 3.5 プロバイダー形式変換のプロパティテストを作成
    - **プロパティ 15: プロバイダー固有の形式変換**
    - **検証: 要件 6.2, 6.3, 6.4**
  
  - [x] 3.6 APIキー使用のユニットテストを作成
    - リクエストヘッダーに適切なAPIキーが含まれることを検証
    - _要件: 5.3_

- [x] 4. チェックポイント - バックエンドコア機能の確認
  - 全てのテストが通ることを確認し、質問があればユーザーに確認してください。

- [x] 5. FastAPI エンドポイントの実装
  - [x] 5.1 FastAPIアプリケーションを初期化
    - CORSミドルウェアを設定（フロントエンドとの通信用）
    - ログ設定を実装
    - 起動時のAPIキー検証を実装
    - _要件: 5.2, 9.2_
  
  - [x] 5.2 /api/modelsエンドポイントを実装
    - 利用可能なモデルリストを返すGETエンドポイント
    - ModelInfo型を定義（id, name, provider, description）
    - _要件: 2.1_
  
  - [x] 5.3 /api/chatエンドポイントを実装
    - ChatRequest型を定義（message, model, history）
    - Server-Sent Events（SSE）を使用したストリーミングレスポンスを実装
    - LLMServiceを呼び出してストリーミングチャットを処理
    - 完了後にメッセージをデータベースに保存
    - _要件: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2, 4.4_
  
  - [x] 5.4 エラーハンドリングを実装
    - レート制限エラー、認証エラー、ネットワークエラーの処理
    - 適切なHTTPステータスコードとエラーメッセージを返す
    - エラーログの記録
    - _要件: 1.5, 7.1, 7.2, 7.3, 7.4, 4.5_
  
  - [x] 5.5 SSE接続のユニットテストを作成
    - ストリーミング接続の確立を検証
    - ストリーミング完了時の接続クローズを検証
    - _要件: 4.1, 4.4_
  
  - [x] 5.6 エラーハンドリングのユニットテストを作成
    - 各種エラー時の適切なレスポンスを検証
    - エラー後の状態維持を検証
    - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 6. フロントエンド データ型とインターフェースの定義
  - [x] 6.1 TypeScript型定義を作成
    - Message型を定義（id, role, content, model, timestamp）
    - ChatRequest型を定義
    - ModelInfo型を定義
    - _要件: 1.1, 2.1_

- [x] 7. フロントエンド APIサービスの実装
  - [x] 7.1 ChatServiceクラスを実装
    - sendMessage関数を実装（SSEストリーミング受信）
    - getModels関数を実装
    - エラーハンドリングを実装（ネットワークエラー、HTTPエラー）
    - _要件: 1.1, 1.2, 1.3, 2.1, 4.3, 7.3_
  
  - [x] 7.2 ChatServiceのユニットテストを作成
    - MSWを使用してAPIモックを作成
    - ストリーミングレスポンスの受信を検証
    - エラーハンドリングを検証
    - _要件: 1.2, 1.3, 4.3, 7.3_

- [x] 8. フロントエンド UIコンポーネントの実装
  - [x] 8.1 MessageListコンポーネントを実装
    - メッセージ一覧の表示
    - ユーザーとアシスタントのメッセージの視覚的区別
    - 自動スクロール機能
    - _要件: 8.1, 8.2, 8.5_
  
  - [x] 8.2 MessageInputコンポーネントを実装
    - テキスト入力フィールド
    - 送信ボタン（空入力時は無効化）
    - モデル選択ドロップダウン
    - ローディングインジケーター
    - _要件: 8.1, 8.3, 8.4_
  
  - [x] 8.3 ChatInterfaceコンポーネントを実装
    - MessageListとMessageInputを統合
    - メッセージ送信ロジックを実装
    - ストリーミングレスポンスの受信と表示
    - エラー表示
    - モデル選択の管理
    - _要件: 1.1, 1.2, 1.3, 1.5, 2.2, 2.3, 2.4, 8.1_
  
  - [x] 8.4 UIコンポーネントのユニットテストを作成
    - 空入力時の送信ボタン無効化を検証
    - メッセージ送信後の表示を検証
    - モデル選択の動作を検証
    - エラー表示を検証
    - _要件: 8.3, 8.4, 8.5_
  
  - [x] 8.5 自動スクロールのプロパティテストを作成
    - **プロパティ 17: 自動スクロール**
    - **検証: 要件 8.2**

- [x] 9. チェックポイント - フロントエンド機能の確認
  - 全てのテストが通ることを確認し、質問があればユーザーに確認してください。

- [x] 10. 統合とエンドツーエンド接続
  - [x] 10.1 バックエンドとフロントエンドを接続
    - フロントエンドのAPIエンドポイントURLを設定
    - CORSの動作を確認
    - _要件: 9.6_
  
  - [x] 10.2 開発環境のセットアップドキュメントを作成
    - README.mdに環境変数の設定方法を記載
    - バックエンドとフロントエンドの起動手順を記載
    - _要件: 9.5_
  
  - [x] 10.3 統合テストを作成
    - チャットフロー全体の動作を検証
    - ストリーミングレスポンスの受信と表示を検証
    - エラーハンドリングを検証
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 11. 最終チェックポイント - 全機能の確認
  - 全てのテストが通ることを確認し、質問があればユーザーに確認してください。

- [x] 12. フロントエンドテストファイルの再構成
  - [x] 12.1 testsディレクトリを作成
    - frontend/testsディレクトリを作成
    - frontend/tests/components、frontend/tests/services、frontend/tests/integrationサブディレクトリを作成
  
  - [x] 12.2 テストファイルを移動
    - src/components/*.test.tsx を tests/components/ に移動
    - src/components/*.property.test.tsx を tests/components/ に移動
    - src/services/*.test.ts を tests/services/ に移動
    - src/integration.test.tsx を tests/integration/ に移動
  
  - [x] 12.3 テスト設定を更新
    - vitest.config.ts のテストパスを更新
    - インポートパスを修正（必要に応じて）
    - 全てのテストが正常に実行されることを確認

- [x] 13. Playwright E2Eテストの実装
  - [x] 13.1 Playwrightのセットアップ
    - Playwrightをインストール（npm install -D @playwright/test）
    - playwright.config.ts を作成
    - e2eテスト用のディレクトリ構造を作成（frontend/e2e/）
    - _要件: 9.5_
  
  - [x] 13.2 基本的なE2Eテストを作成
    - チャットインターフェースの表示テスト
    - メッセージ送信フローのテスト
    - モデル選択のテスト
    - _要件: 1.1, 2.2, 8.1_
  
  - [x] 13.3 ストリーミングレスポンスのE2Eテスト
    - ストリーミング中のリアルタイム表示を検証
    - ローディング状態の表示を検証
    - _要件: 1.2, 1.3, 8.3_
  
  - [x] 13.4 エラーハンドリングのE2Eテスト
    - ネットワークエラー時の表示を検証
    - APIエラー時の表示を検証
    - エラー後の再試行を検証
    - _要件: 1.5, 7.3, 7.5_
  
  - [x] 13.5 E2Eテストの実行スクリプトを追加
    - package.jsonにe2eテスト実行スクリプトを追加
    - README.mdにE2Eテストの実行方法を記載

- [x] 14. 最終チェックポイント - テスト再構成の確認
  - 全てのユニットテスト、プロパティテスト、E2Eテストが通ることを確認してください。

## 注意事項

- `*`マークが付いたタスクはオプションであり、より速いMVP開発のためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
